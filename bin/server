#!/bin/bash

silent() {
  $@ 2&> /dev/null
}


print_in_color() {
    printf "%b" \
        "$(tput setaf "$2" 2> /dev/null)" \
        "$1" \
        "$(tput sgr0 2> /dev/null)"
}

print_result() {
    if [ "$?" -eq 0 ]; then
        print_in_color "  [✓] $1\n" 2
    else
        print_in_color "  [𝘅] $1 $2\n" 1
    fi
}

ask_for_sudo() {
    sudo -v &> /dev/null
    while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &
}

startApache() {
  if [[ ! -d /run/apache2 ]]; then
    sudo mkdir /run/apache2
  fi

  sudo apache2 -k start > /dev/null
  print_result "Apache"
}

startMongo() {
  if [[ -e /home/deanacus/.mongo/log/mongod.log ]]; then
    sudo mv /home/deanacus/.mongo/log/mongod.log /home/deanacus/.mongo/log/mongod.$(date +"%m-%d-%y-%H:%M:%S").log
    touch /home/deanacus/.mongo/log/mongod.log
  fi

  sudo mongod -f /etc/mongod.conf > /dev/null
  print_result "Mongo"
}

startMysql() {
  if [[ ! -d /run/mysqld ]]; then
    sudo mkdir /run/mysqld && sudo chown mysql:mysql /run/mysqld
  fi

  sudo mysqld --user=mysql --sql_mode="STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION" -D > /dev/null
  print_result "MySQL"
}

start() {
    startApache
    startMongo
    startMysql
}

stopMysql() {
  silent sudo killall mysqld
  print_result "MySQL"
}

stopApache() {
  silent sudo killall apache2
  print_result "Apache"
}

stopMongo() {
  silent sudo killall mongod
  print_result "Mongo"
}

stop() {
  stopApache
  stopMongo
  stopMysql
}

status() {
  test $(ps -aux | grep -o "mysql" | wc -l) != "1"
  print_result "MySQL"
  test $(ps -aux | grep -o "apache2" | wc -l) != "1"
  print_result "Apache"
  test $(ps -aux | grep -o "mongo" | wc -l) != "1"
  print_result "Mongo"
}

restart() {
  stopMysql
  startMysql
  print_result "MySQL"
  stopApache
  startApache
  print_result "Apache"
  stopMongo
  startMongo
  print_result "Mongo"
}

main() {
  ask_for_sudo
  case $1 in
    start*)
      start
      ;;
    stop*)
      stop
      ;;
    status*)
      status
      ;;
    restart*)
      restart
      ;;
    *)
      exit 1;
  esac
}

main $@